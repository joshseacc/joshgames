<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學位值大冒險</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            touch-action: manipulation; /* Improves touch response */
        }
        .bead {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .bead:active {
            transform: scale(0.9);
        }
        .card-slot {
            transition: all 0.2s;
        }
        .animate-pop {
            animation: pop 0.3s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Utility Functions ---

        // Check if a number is odd (單數) or even (雙數)
        const isOdd = (num) => num % 2 !== 0;
        
        // Helper to generate text based on language
        const getText = (lang, key) => {
            const dictionary = {
                zh: {
                    largest: "最大",
                    smallest: "最小",
                    odd: "單數",
                    even: "雙數",
                    target: "目標",
                    check: "檢查答案",
                    correct: "答對了！",
                    wrong: "再試一次",
                    next: "下一題",
                    reset: "重置",
                    menu: "主選單",
                    level: "第",
                    question: "題",
                    beadsCount: "數珠數量",
                    make: "請構成",
                    digit: "位",
                    completed: "恭喜完成！",
                    score: "得分",
                    instructionBead: "點擊數珠台的柱子來放置或取回數珠。",
                    instructionCard: "點擊下方的數字卡放入空格，再次點擊空格可取回。",
                    cols: ["個", "十", "百", "千", "萬"]
                },
                en: {
                    largest: "Largest",
                    smallest: "Smallest",
                    odd: "Odd",
                    even: "Even",
                    target: "Target",
                    check: "Check Answer",
                    correct: "Correct!",
                    wrong: "Try Again",
                    next: "Next Question",
                    reset: "Reset",
                    menu: "Main Menu",
                    level: "Level",
                    question: "",
                    beadsCount: "Beads",
                    make: "Make the",
                    digit: "-digit",
                    completed: "Level Complete!",
                    score: "Score",
                    instructionBead: "Click columns to add/remove beads.",
                    instructionCard: "Click cards to place/remove them.",
                    cols: ["Units", "Tens", "Hundreds", "Thousands", "Ten Thousands"]
                }
            };
            return dictionary[lang][key];
        };

        // --- Game Logic Solvers ---

        // Solver for Bead Game
        const solveBeadProblem = (totalBeads, columnsCount, isMax, isOddTarget) => {
            // Brute force checks aren't efficient for high bead counts, so we use logic.
            // But for n=20 beads and 5 columns, it's small enough to use a greedy construction algorithm.
            
            let bestVal = isMax ? -1 : Infinity;
            
            // Recursive generator for partitions
            function findPartitions(targetSum, numBins, currentArr = []) {
                if (numBins === 1) {
                    if (targetSum >= 0 && targetSum <= 9) {
                        const finalArr = [...currentArr, targetSum];
                        // Validate
                        const lastDigit = finalArr[finalArr.length - 1];
                        const numIsOdd = lastDigit % 2 !== 0;
                        if (numIsOdd === isOddTarget) {
                            // Check for leading zeros if length > 1
                            if (finalArr.length > 1 && finalArr[0] === 0) return;

                            const val = parseInt(finalArr.join(''));
                            if (isMax) {
                                if (val > bestVal) bestVal = val;
                            } else {
                                if (val < bestVal) bestVal = val;
                            }
                        }
                    }
                    return;
                }

                // Optimization: Iterate 9 down to 0 for Max, 0 up to 9 for Min
                const loopStart = isMax ? 9 : 0;
                const loopEnd = isMax ? -1 : 10;
                const step = isMax ? -1 : 1;

                for (let i = loopStart; i !== loopEnd; i += step) {
                    if (targetSum - i >= 0) { // Can't use more beads than available
                        // Quick check: can we fill remaining bins? (Max 9 * remaining bins)
                        if ((targetSum - i) <= 9 * (numBins - 1)) {
                             findPartitions(targetSum - i, numBins - 1, [...currentArr, i]);
                        }
                    }
                }
            }

            findPartitions(totalBeads, columnsCount);
            return bestVal === Infinity || bestVal === -1 ? null : bestVal;
        };

        // Solver for Card Game
        const solveCardProblem = (cards, slots, isMax, isOddTarget) => {
            let bestVal = isMax ? -1 : Infinity;
            
            // Permutation generator
            const permute = (arr, m = []) => {
                if (m.length === slots) {
                    const numVal = parseInt(m.join(''));
                    const lastDigit = m[m.length - 1];
                    const numIsOdd = lastDigit % 2 !== 0;

                    if (numIsOdd === isOddTarget) {
                         if (isMax) {
                            if (numVal > bestVal) bestVal = numVal;
                        } else {
                            if (numVal < bestVal) bestVal = numVal;
                        }
                    }
                    return;
                }
                for (let i = 0; i < arr.length; i++) {
                    let curr = arr.slice();
                    let next = curr.splice(i, 1);
                    permute(curr.slice(), m.concat(next));
                }
            };

            permute(cards);
            return bestVal === Infinity || bestVal === -1 ? null : bestVal;
        };


        // --- Components ---

        // 1. Menu Screen
        const MainMenu = ({ onSelectMode }) => {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 space-y-6 max-w-md mx-auto">
                    <h1 className="text-3xl font-bold text-blue-600 mb-4 text-center">數學位值大冒險</h1>
                    
                    <button onClick={() => onSelectMode(1)} className="w-full bg-white border-2 border-blue-400 p-4 rounded-xl shadow-lg hover:bg-blue-50 transition transform hover:scale-105 text-left">
                        <div className="font-bold text-lg text-blue-800">1. 數珠挑戰 (中文)</div>
                        <div className="text-sm text-gray-500">20題 | 兩位數 | 大小單雙</div>
                    </button>

                    <button onClick={() => onSelectMode(2)} className="w-full bg-white border-2 border-green-400 p-4 rounded-xl shadow-lg hover:bg-green-50 transition transform hover:scale-105 text-left">
                        <div className="font-bold text-lg text-green-800">2. 數字卡排排看 (中文)</div>
                        <div className="text-sm text-gray-500">20題 | 兩位數 | 大小單雙</div>
                    </button>

                    <button onClick={() => onSelectMode(3)} className="w-full bg-white border-2 border-purple-400 p-4 rounded-xl shadow-lg hover:bg-purple-50 transition transform hover:scale-105 text-left">
                        <div className="font-bold text-lg text-purple-800">3. Card Sorting (English)</div>
                        <div className="text-sm text-gray-500">20 Levels | 5 Digits | Max/Min Odd/Even</div>
                    </button>

                    <button onClick={() => onSelectMode(4)} className="w-full bg-white border-2 border-orange-400 p-4 rounded-xl shadow-lg hover:bg-orange-50 transition transform hover:scale-105 text-left">
                        <div className="font-bold text-lg text-orange-800">4. Bead Master (English)</div>
                        <div className="text-sm text-gray-500">20 Levels | 5 Digits | Place Value</div>
                    </button>
                </div>
            );
        };

        // 2. Bead Game Component
        const BeadGame = ({ modeConfig, onBack }) => {
            const [level, setLevel] = useState(1);
            const [score, setScore] = useState(0);
            const [question, setQuestion] = useState(null);
            const [columns, setColumns] = useState([]); // Array of counts per column
            const [message, setMessage] = useState("");
            const [isCorrect, setIsCorrect] = useState(null);
            const [showSolution, setShowSolution] = useState(false);

            // Generate Question
            useEffect(() => {
                generateLevel();
            }, [level]);

            const generateLevel = () => {
                setIsCorrect(null);
                setMessage("");
                setShowSolution(false);

                const isEnglish = modeConfig.lang === 'en';
                
                // Determine difficulty based on level
                // Last 2 levels are challenge levels
                let colsCount = modeConfig.defaultCols;
                if (modeConfig.id === 1 && level >= 19) colsCount = 3; // Challenge for Mode 1

                const isMax = Math.random() > 0.5;
                const isOddTarget = Math.random() > 0.5;

                // Random total beads. Ensure it's solvable.
                let totalBeads, solution;
                let attempts = 0;
                do {
                    // Min 1 bead, Max 9 * cols
                    const minBeads = 1;
                    const maxBeads = Math.min(modeConfig.maxBeadsTotal, 9 * colsCount); 
                    totalBeads = Math.floor(Math.random() * (maxBeads - minBeads + 1)) + minBeads;
                    
                    solution = solveBeadProblem(totalBeads, colsCount, isMax, isOddTarget);
                    attempts++;
                } while (solution === null && attempts < 100);

                if (solution === null) {
                    // Fallback safety
                    totalBeads = 3; 
                    solution = solveBeadProblem(3, colsCount, true, true);
                }

                setColumns(Array(colsCount).fill(0));
                setQuestion({
                    totalBeads,
                    isMax,
                    isOddTarget,
                    solution,
                    colsCount
                });
            };

            const usedBeads = columns.reduce((a, b) => a + b, 0);
            const remainingBeads = question ? question.totalBeads - usedBeads : 0;
            const currentNumber = parseInt(columns.join('')) || 0;

            const handleColumnClick = (idx) => {
                if (isCorrect) return;

                const newCols = [...columns];
                
                // Logic: Click to ADD. If full or no beads left, maybe remove?
                // Let's implement: Click top half to add, click bead itself to remove?
                // Simpler: Just click column. If beads avail, add. If used max for this col (9), don't add.
                // To remove: Add a "Reset" or specific interaction. 
                // Better UX: Click empty space in col -> Add. Click existing bead -> Remove.
                
                // Since clicking specific bead is hard in DOM, let's just cycle or use buttons?
                // Prompt: "Place beads into bead table".
                // Let's do: Click column -> Add bead. 
                // Need a way to remove. Maybe a small "-" button below each col?
                // Or: If beads remain, add 1. If 0 beads remain, do nothing?
                // Let's do: Click column adds 1. If reaches 9 or no beads left, it cycles back to 0? No that's confusing.
                // Approach: Click column header to Add. Click column footer (or number) to Remove.
                
                if (remainingBeads > 0 && newCols[idx] < 9) {
                    newCols[idx]++;
                    setColumns(newCols);
                } else if (newCols[idx] > 0 && remainingBeads === 0) {
                     // If no beads left, clicking might imply user wants to fix mistake, so remove one?
                     newCols[idx]--;
                     setColumns(newCols);
                } else {
                     // Shake effect or visual cue could go here
                }
            };
            
            const removeBead = (idx) => {
                if (isCorrect) return;
                const newCols = [...columns];
                if (newCols[idx] > 0) {
                    newCols[idx]--;
                    setColumns(newCols);
                }
            }

            const checkAnswer = () => {
                if (remainingBeads !== 0) {
                    setMessage(modeConfig.lang === 'en' ? "Place all beads!" : "請使用所有數珠！");
                    return;
                }

                const userVal = parseInt(columns.join(''));
                
                // Check parity
                const userIsOdd = userVal % 2 !== 0;
                if (userIsOdd !== question.isOddTarget) {
                    setMessage(modeConfig.lang === 'en' 
                        ? `It must be ${question.isOddTarget ? 'Odd' : 'Even'}!` 
                        : `數字必須是${question.isOddTarget ? '單數' : '雙數'}！`);
                    return;
                }

                if (userVal === question.solution) {
                    setIsCorrect(true);
                    setScore(score + 10);
                    setMessage(getText(modeConfig.lang, 'correct'));
                } else {
                    setMessage(getText(modeConfig.lang, 'wrong'));
                }
            };

            const nextLevel = () => {
                if (level < 20) {
                    setLevel(level + 1);
                } else {
                    setMessage(getText(modeConfig.lang, 'completed'));
                }
            };

            if (!question) return <div>Loading...</div>;

            const lang = modeConfig.lang;
            
            // Generate question text based on new requirements
            let instruction = null;
            if (lang === 'zh') {
                 const sizeStr = question.isMax ? '最大' : '最小';
                 const digitStr = question.colsCount === 2 ? '兩' : (question.colsCount === 5 ? '五' : question.colsCount);
                 const parityStr = question.isOddTarget ? '單數' : '雙數';
                 
                 instruction = (
                    <>
                        在算柱上畫 <span className="text-3xl text-blue-600 font-bold mx-1">{question.totalBeads}</span> 粒算珠，
                        <div className="mt-2">
                            表示出 <span className="text-blue-600 font-bold">{sizeStr}</span> 的 <span className="text-blue-600 font-bold">{digitStr}位{parityStr}</span>。
                        </div>
                    </>
                 );
            } else {
                 // English
                 const sizeStr = question.isMax ? 'largest' : 'smallest';
                 const parityStr = question.isOddTarget ? 'odd' : 'even';
                 instruction = (
                    <>
                        Use <span className="text-3xl text-blue-600 font-bold mx-1">{question.totalBeads}</span> beads to make the
                        <div className="mt-2">
                             <span className="text-blue-600 font-bold">{sizeStr}</span> {question.colsCount}-digit <span className="text-blue-600 font-bold">{parityStr} number</span>.
                        </div>
                    </>
                 );
            }

            return (
                <div className="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-xl overflow-hidden">
                    {/* Header */}
                    <div className="bg-blue-600 text-white p-4 flex justify-between items-center">
                        <button onClick={onBack} className="text-sm bg-blue-700 px-3 py-1 rounded hover:bg-blue-800">
                             &lt; {getText(lang, 'menu')}
                        </button>
                        <div className="font-bold text-lg">{getText(lang, 'level')} {level}/20</div>
                        <div className="font-bold text-yellow-300">★ {score}</div>
                    </div>

                    {/* Question Area */}
                    <div className="p-6 bg-blue-50 text-center">
                        <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-2 leading-relaxed">
                             {instruction}
                        </h2>
                        <div className="text-sm text-gray-500 mt-2">{getText(lang, 'instructionBead')}</div>
                    </div>

                    {/* Game Board */}
                    <div className="flex-1 flex flex-col items-center justify-center p-2 bg-slate-100">
                        {/* Remaining Beads Indicator */}
                        <div className="mb-4 flex gap-1 h-8">
                            {Array(remainingBeads).fill(0).map((_, i) => (
                                <div key={i} className="w-4 h-4 rounded-full bg-red-400 animate-pop"></div>
                            ))}
                        </div>

                        {/* Abacus */}
                        <div className="flex justify-center items-end gap-2 md:gap-6 bg-white p-4 md:p-8 rounded-xl shadow-inner border-b-4 border-gray-300">
                            {columns.map((count, idx) => {
                                // Calculate column label index (reverse logical index)
                                // If colsCount = 2 (Tens, Units). idx 0 is Tens, idx 1 is Units.
                                // Logic: idx 0 is Highest Value.
                                const colLabelIdx = question.colsCount - 1 - idx; 
                                const colName = getText(lang, 'cols')[colLabelIdx];
                                
                                // Visualizing size: Tens/Higher are larger
                                const isBig = colLabelIdx >= 1; 

                                return (
                                    <div key={idx} className="flex flex-col items-center">
                                        
                                        {/* Bead Stack */}
                                        <div 
                                            className="w-12 md:w-16 h-48 md:h-64 bg-gray-100 rounded-t-lg relative flex flex-col-reverse justify-start items-center p-1 cursor-pointer border-2 border-transparent hover:border-blue-200 transition-colors"
                                            onClick={() => handleColumnClick(idx)}
                                        >
                                            {/* Rod */}
                                            <div className="absolute top-0 bottom-0 left-1/2 w-1 bg-gray-300 -translate-x-1/2 z-0"></div>
                                            
                                            {/* Beads */}
                                            {Array(count).fill(0).map((_, bIdx) => (
                                                <div 
                                                    key={bIdx} 
                                                    className={`
                                                        z-10 rounded-full border border-black/10 shadow-sm mb-1
                                                        ${isBig ? 'w-10 h-8 md:w-12 md:h-9 bg-orange-400' : 'w-8 h-6 md:w-10 md:h-7 bg-yellow-400'}
                                                        animate-pop
                                                    `}
                                                ></div>
                                            ))}
                                            
                                            {/* Placeholder for touch target */}
                                            <div className="flex-1 w-full z-20"></div>
                                        </div>

                                        {/* Controls / Label */}
                                        <div className="mt-2 text-center">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); removeBead(idx); }}
                                                className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600 mb-1 flex items-center justify-center font-bold"
                                                disabled={isCorrect}
                                            >-</button>
                                            <div className="text-2xl font-bold text-gray-800">{count}</div>
                                            <div className="text-xs md:text-sm text-gray-500 font-bold">{colName}</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Footer Controls */}
                    <div className="bg-white p-4 border-t flex flex-col items-center gap-3">
                        <div className={`text-lg font-bold ${isCorrect ? 'text-green-600' : 'text-red-500'} h-8`}>
                            {message}
                        </div>
                        
                        {!isCorrect ? (
                            <div className="flex gap-4 w-full max-w-xs">
                                <button onClick={() => setColumns(Array(question.colsCount).fill(0))} className="flex-1 py-3 rounded-lg bg-gray-200 text-gray-700 font-bold hover:bg-gray-300">
                                    {getText(lang, 'reset')}
                                </button>
                                <button onClick={checkAnswer} className="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg">
                                    {getText(lang, 'check')}
                                </button>
                            </div>
                        ) : (
                            <button onClick={nextLevel} className="w-full max-w-xs py-3 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 shadow-lg animate-bounce">
                                {getText(lang, 'next')}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // 3. Card Game Component
        const CardGame = ({ modeConfig, onBack }) => {
            const [level, setLevel] = useState(1);
            const [score, setScore] = useState(0);
            const [question, setQuestion] = useState(null);
            
            // State for cards
            const [hand, setHand] = useState([]); // Cards available to pick
            const [slots, setSlots] = useState([]); // Placed cards (null if empty)
            
            const [message, setMessage] = useState("");
            const [isCorrect, setIsCorrect] = useState(null);

            useEffect(() => {
                generateLevel();
            }, [level]);

            const generateLevel = () => {
                setIsCorrect(null);
                setMessage("");
                
                const isMax = Math.random() > 0.5;
                const isOddTarget = Math.random() > 0.5;
                
                // Config based on mode
                let numSlots = modeConfig.slots; // 2 or 5
                let numCards = 0;

                if (modeConfig.id === 2) {
                    // Mode 2: 3-5 cards
                    numCards = Math.floor(Math.random() * 3) + 3;
                } else {
                    // Mode 3: 5-8 cards
                    numCards = Math.floor(Math.random() * 4) + 5;
                }

                // Generate random unique digits for hand
                let availableDigits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                let deck = [];
                
                // Ensure solvency: If Odd target, ensure at least one odd digit exists.
                // If Even target, ensure at least one even digit exists.
                // Also, first digit cannot be 0 if slots > 1 (though logic handles this, usually cards are 1-9 to avoid confusion? Let's allow 0 but handle leading zero logic or just ban 0 for simplicity in kids game)
                // Let's remove 0 to simplify "Two digit number" rules for kids (avoiding 05 vs 5).
                availableDigits = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                
                // Create deck
                let attempts = 0;
                let solution = null;
                
                do {
                    // Shuffle
                    availableDigits.sort(() => Math.random() - 0.5);
                    deck = availableDigits.slice(0, numCards);
                    
                    solution = solveCardProblem(deck, numSlots, isMax, isOddTarget);
                    attempts++;
                } while (solution === null && attempts < 50);

                if (solution === null) {
                    // Fallback
                    deck = [1, 2, 3, 4, 5];
                    solution = solveCardProblem(deck, numSlots, true, true);
                }

                setQuestion({
                    isMax,
                    isOddTarget,
                    solution,
                    numSlots
                });
                
                // Hand items: { id: unique, val: number, isUsed: boolean }
                setHand(deck.map((val, i) => ({ id: i, val, isUsed: false })));
                setSlots(Array(numSlots).fill(null));
            };

            const handleHandClick = (cardIndex) => {
                if (isCorrect) return;
                const card = hand[cardIndex];
                if (card.isUsed) return; // Already placed

                // Find first empty slot
                const firstEmpty = slots.findIndex(s => s === null);
                if (firstEmpty !== -1) {
                    const newSlots = [...slots];
                    newSlots[firstEmpty] = card;
                    setSlots(newSlots);

                    const newHand = [...hand];
                    newHand[cardIndex].isUsed = true;
                    setHand(newHand);
                }
            };

            const handleSlotClick = (slotIndex) => {
                if (isCorrect) return;
                const card = slots[slotIndex];
                if (!card) return;

                // Return to hand
                const newHand = [...hand];
                const handIdx = newHand.findIndex(c => c.id === card.id);
                newHand[handIdx].isUsed = false;
                setHand(newHand);

                // Clear slot
                const newSlots = [...slots];
                newSlots[slotIndex] = null;
                setSlots(newSlots);
            };

            const checkAnswer = () => {
                if (slots.some(s => s === null)) {
                    setMessage(modeConfig.lang === 'en' ? "Fill all slots!" : "請填滿所有空格！");
                    return;
                }

                const userValStr = slots.map(c => c.val).join('');
                const userVal = parseInt(userValStr);
                
                const userIsOdd = userVal % 2 !== 0;
                if (userIsOdd !== question.isOddTarget) {
                     setMessage(modeConfig.lang === 'en' 
                        ? `It must be ${question.isOddTarget ? 'Odd' : 'Even'}!` 
                        : `數字必須是${question.isOddTarget ? '單數' : '雙數'}！`);
                    return;
                }

                if (userVal === question.solution) {
                    setIsCorrect(true);
                    setScore(score + 10);
                    setMessage(getText(modeConfig.lang, 'correct'));
                } else {
                    setMessage(getText(modeConfig.lang, 'wrong'));
                }
            };

             const nextLevel = () => {
                if (level < 20) {
                    setLevel(level + 1);
                } else {
                    setMessage(getText(modeConfig.lang, 'completed'));
                }
            };

            if (!question) return <div>Loading...</div>;
            const lang = modeConfig.lang;
            const targetText = `${getText(lang, question.isMax ? 'largest' : 'smallest')} ${question.numSlots}${getText(lang, 'digit')} ${getText(lang, question.isOddTarget ? 'odd' : 'even')}`;

            return (
                 <div className="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-xl overflow-hidden">
                    {/* Header */}
                    <div className="bg-purple-600 text-white p-4 flex justify-between items-center">
                        <button onClick={onBack} className="text-sm bg-purple-700 px-3 py-1 rounded hover:bg-purple-800">
                             &lt; {getText(lang, 'menu')}
                        </button>
                        <div className="font-bold text-lg">{getText(lang, 'level')} {level}/20</div>
                        <div className="font-bold text-yellow-300">★ {score}</div>
                    </div>

                    {/* Question */}
                    <div className="p-6 bg-purple-50 text-center">
                         <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-2">
                             {getText(lang, 'make')} <span className="text-purple-600">{targetText}</span>
                        </h2>
                         <div className="text-sm text-gray-500 mt-1">{getText(lang, 'instructionCard')}</div>
                    </div>

                    {/* Game Area */}
                    <div className="flex-1 flex flex-col items-center justify-center p-4 bg-slate-100 space-y-8">
                        
                        {/* Slots */}
                        <div className="flex gap-2 md:gap-4 items-center justify-center p-4 bg-white rounded-xl shadow-sm">
                            {slots.map((card, idx) => (
                                <div 
                                    key={idx} 
                                    onClick={() => handleSlotClick(idx)}
                                    className={`
                                        w-12 h-16 md:w-16 md:h-24 rounded-lg border-2 border-dashed flex items-center justify-center text-3xl font-bold cursor-pointer transition-all
                                        ${card ? 'bg-white border-purple-500 shadow-md border-solid' : 'bg-gray-100 border-gray-300'}
                                    `}
                                >
                                    {card ? card.val : ''}
                                </div>
                            ))}
                        </div>

                        {/* Hand */}
                        <div className="flex flex-wrap gap-3 justify-center">
                            {hand.map((card, idx) => (
                                <div 
                                    key={card.id}
                                    onClick={() => handleHandClick(idx)}
                                    className={`
                                        w-12 h-16 md:w-16 md:h-24 rounded-lg bg-white border-2 border-gray-200 shadow-lg flex items-center justify-center text-3xl font-bold cursor-pointer
                                        ${card.isUsed ? 'opacity-0 pointer-events-none' : 'hover:-translate-y-2 transition-transform'}
                                    `}
                                >
                                    {card.val}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="bg-white p-4 border-t flex flex-col items-center gap-3">
                        <div className={`text-lg font-bold ${isCorrect ? 'text-green-600' : 'text-red-500'} h-8`}>
                            {message}
                        </div>
                        
                        {!isCorrect ? (
                             <div className="flex gap-4 w-full max-w-xs">
                                <button onClick={() => {
                                    setSlots(Array(question.numSlots).fill(null));
                                    setHand(hand.map(c => ({...c, isUsed: false})));
                                }} className="flex-1 py-3 rounded-lg bg-gray-200 text-gray-700 font-bold hover:bg-gray-300">
                                    {getText(lang, 'reset')}
                                </button>
                                <button onClick={checkAnswer} className="flex-1 py-3 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 shadow-lg">
                                    {getText(lang, 'check')}
                                </button>
                            </div>
                        ) : (
                             <button onClick={nextLevel} className="w-full max-w-xs py-3 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 shadow-lg animate-bounce">
                                {getText(lang, 'next')}
                            </button>
                        )}
                    </div>
                 </div>
            );
        };

        // Main App Container
        const App = () => {
            const [mode, setMode] = useState(null); // 1, 2, 3, 4, or null (menu)

            const modeConfigs = {
                1: { id: 1, type: 'bead', lang: 'zh', defaultCols: 2, maxBeadsTotal: 12 },
                2: { id: 2, type: 'card', lang: 'zh', slots: 2 },
                3: { id: 3, type: 'card', lang: 'en', slots: 5 },
                4: { id: 4, type: 'bead', lang: 'en', defaultCols: 5, maxBeadsTotal: 25 }
            };

            const handleBack = () => setMode(null);

            if (!mode) return <MainMenu onSelectMode={setMode} />;

            const config = modeConfigs[mode];
            if (config.type === 'bead') {
                return <BeadGame modeConfig={config} onBack={handleBack} />;
            } else {
                return <CardGame modeConfig={config} onBack={handleBack} />;
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>